<html>
    <head>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js'></script>
    <style>
        ul{
            list-style: none;
        }
        body{
            font-family: verdana;
        }
        button{
            height: 2rem;
            font-size: 1rem;
        }
        .destroy{
            height: 1.5rem;
            font-size: 0.5rem;
            width: 100%
        }
        hr{
            border-color: orange;
        }
        
    </style>

    </head>
    <body>

        <!-- HTML -->
        <div id='root'></div>
        <!-- HTML -->

        <script type='text/babel'>

            const API = 'https://acme-users-api-rev.herokuapp.com/api';
            
            const fetchUser = async ()=> {
                const storage = window.localStorage;
                const userId = storage.getItem('userId'); 
                if(userId){
                try {
                    return (await axios.get(`${API}/users/detail/${userId}`)).data;
                }
                catch(ex){
                    storage.removeItem('userId');
                    return fetchUser();
                }
                }
                const user = (await axios.get(`${API}/users/random`)).data;
                storage.setItem('userId', user.id);
                return  user;
            };
            const noteString = "The cat went for a walk. The dog learned how to talk. The monkey went to bed. The gorilla invented the pillow."
            const randomNote = (str) => {
                const arr = str.split(".")
                const index = Math.floor(Math.random() * arr.length)
                return {text: arr[index].trim()}
    
            }

            const { render } = ReactDOM;
            const { Component } = React;

            class App extends Component{
                constructor(){
                    super();
                        this.state = {
                            user: {},
                            companies: [],
                            vacations: [],
                            notes: [],
                            following: [],
                            error: ''
                        };
                        this.destroyNotes = this.destroyNotes.bind(this)
                        this.destroyFollowing = this.destroyFollowing.bind(this)
                        this.create = this.create.bind(this)
                }
                async destroyNotes(note) {
                    await axios.delete(`${API}/users/${this.state.user.id}/notes/${note.id}`);
                    this.setState({notes : this.state.notes.filter(_note => _note.id !== note.id)});
                }
                async destroyFollowing(follow) {
                    await axios.delete(`${API}/users/${this.state.user.id}/followingCompanies/${follow.id}`);
                    this.setState({following : this.state.following.filter(_follow => _follow.id !== follow.id)})
                }
                async destroyVacations(vacay){
                    await axios.delete(`${API}/users/${this.state.user.id}/vacations/${vacay.id}`);
                    this.setState({vacations : this.state.vacations.filter(_vacay => _vacay.id !== vacay.id) })
                }
                async create(note){
                    const text = randomNote(noteString)
                    const notes = [...this.state.notes, text ];
                    this.setState({ notes }); 
                }
                async componentDidMount(){
                    const user = await fetchUser();
                    const vacations = (await axios.get(`${API}/users/${user.id}/vacations`)).data;
                    const notes = (await axios.get(`${API}/users/${user.id}/notes`)).data;
                    const following = (await axios.get(`${API}/users/${user.id}/followingCompanies`)).data;
                    this.setState({user, vacations, notes, following});
                }

                render(){
                    const { error, user, companies, vacations, following, notes } = this.state;
                    const { destroyNotes, destroyFollowing,  create } = this;
                        return (
                            <div>
                            <h1>The Acme Random Life</h1>
                            Welcome { user.fullName } to your Random Life!
                            <div className='error'>{ error }</div>
                                <div id='notes'>
                                    <h2>Notes({ notes.length })</h2>
                                    <button onClick={()=> create(notes)}> Add a Random Note </button>
                                    <ul>
                                        {
                                        notes.map(note => 
                                        <li key={ note.id }>
                                        { note.text }
                                        <br/>
                                        <button className='destroy' onClick={()=> destroyNotes(note)}>Destroy</button>
                                        </li>)
                                        }
                                    </ul>
                                    <hr/>
                                </div>
                                <div id='followingCompanies'>
                                    <h2>FollowingCompanies({ following.length })</h2>
                                    <button> Add a Random Following Company </button>
                                        <ul>
                                            {
                                            following.map(follow => 
                                            <li key={ follow.id }>
                                            { follow.id }
                                            <br/>
                                            <button className='destroy' onClick={()=> destroyFollowing(follow)}>Destroy</button>
                                            </li>)
                                            }
                                        </ul>
                                    <hr/>
                                </div>
                                <div id='vacations'>
                                    <h2>Vacations({vacations.length})</h2>
                                    <button> Add a Random Vacation</button>
                                        <ul>
                                            {
                                            vacations.map(vacay => 
                                            <li key={ vacay.id }>
                                            { vacay.text }
                                            <br/>
                                            <button className='destroy' onClick={()=> destroy(vacay)}>Destroy</button>
                                            </li>)
                                            }
                                        </ul>
                                    <hr/>
                                </div>
                            </div>
                        );
                }
            }
            render(<App />, document.querySelector('#root'));
        </script>
    </body>
</html>

    